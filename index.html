<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é«˜çº§ç®€æ˜“è®ºå›</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    .container { max-width: 980px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 5px; }
    h1, h2, h3 { color: #333; }
    .login, .register, .post-form, .reply-form, .search-form, .settings-form, .profile-form, .admin-panel { margin-bottom: 20px; }
    .post, .reply { border: 1px solid #ccc; border-radius: 4px; padding: 12px; margin-bottom: 10px; background: #fafafa; }
    .post .title { font-size: 1.2em; font-weight: bold; }
    .post .meta { color: #888; font-size: 0.9em; }
    .reply-list { margin-left: 24px; }
    .error { color: red; }
    .success { color: green; }
    .nav { margin-bottom: 20px; }
    .nav button { margin-right: 7px; }
    label { display: block; margin-top: 7px; }
    input[type="text"], input[type="password"], input[type="email"], textarea, select {
      width: 100%; padding: 7px; margin-top: 5px; box-sizing: border-box;
    }
    textarea { resize: vertical; }
    .admin-btn { color: #c00; font-size: 0.95em; background: none; border: none; cursor: pointer; }
    .sticky { background: #ffeeba; }
    .pagination { margin: 16px 0; text-align: center; }
    .pagination button { margin: 0 2px; }
    .like-btn, .fav-btn { color: #06c; cursor: pointer; background: none; border: none; }
    .liked, .faved { color: #d00; }
    .user-list { margin-top: 18px; }
    .user-list th, .user-list td { padding: 4px 8px; }
    .announcement { border: 1px solid #bcdff1; background: #eaf6fb; padding: 10px; color: #2077a7; border-radius: 4px; margin-bottom: 18px; }
    .draft-btn { color: #888; background: none; border: none; cursor: pointer; font-size: 0.92em; }
    .draft-list { margin: 10px 0 25px 0; }
    .draft-list li { margin-bottom: 3px; }
    .category-label { display: inline-block; border-radius: 3px; font-size: 0.95em; background: #e1eaff; color: #397;
      padding: 0 4px; margin-right: 6px;
    }
    .settings-form { background: #f9f9f9; border-radius: 5px; padding: 8px 15px; border: 1px solid #ddd; }
    .dark-mode { background: #222 !important; color: #eee !important; }
    .dark-mode .container { background: #23272c !important; color: #eee !important; }
    .dark-mode .post, .dark-mode .reply { background: #282c34 !important; border-color: #333; color: #fff !important; }
    .dark-mode .sticky { background: #3a3e43 !important; }
    .dark-mode .announcement { background: #283848 !important; color: #86c5ff !important; border-color: #3c4d61; }
    .dark-mode input, .dark-mode textarea, .dark-mode select { background: #3a3e43; color: #eee; border: 1px solid #444; }
    .dark-mode .admin-btn, .dark-mode .like-btn, .dark-mode .fav-btn, .dark-mode .draft-btn { color: #ffa07a !important; }
    .dark-mode .category-label { background: #335 !important; color: #8f8 !important; }
    .level-badge { display: inline-block; border-radius: 8px; padding: 0 10px; font-size: 0.95em; color: #fff; margin-left: 7px; }
    .level-1 { background: #888; }
    .level-2 { background: #3498db; }
    .level-3 { background: #2ecc71; }
    .level-4 { background: #e67e22; }
    .level-5 { background: #e74c3c; }
    .report-btn { color: #b77; font-size: 0.9em; background: none; border: none; cursor: pointer; }
    .report-form { padding: 8px 0; }
    .report-list { margin: 12px 0; }
    .profile-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 1.5px solid #eee; background: #f3f3f3; }
    .fav-btn.faved { color: #e67e22; }
    .profile-info { display: flex; align-items: center; gap: 20px; margin-bottom: 18px; }
    .profile-details { flex: 1; }
    .video-attach { max-width: 350px; display: block; margin: 8px 0; border-radius: 8px; }
    .color-btn-group button { margin-right: 3px; margin-top: 3px; }
    .profile-form input[type="file"] { width: auto; }
    .ban-btn { color: #fff; background: #e74c3c; border: none; border-radius: 3px; font-size: 0.92em; padding: 1px 8px; cursor: pointer; }
    .admin-panel { border: 1px solid #ccc; padding: 10px; margin-top: 20px; border-radius: 5px; background: #f0f0f0; }
  </style>
</head>
<body id="body">
  <div class="container">
    <h1>é«˜çº§ç®€æ˜“è®ºå›</h1>
    <div id="nav" class="nav"></div>
    <div id="main"></div>
  </div>
  <script>
    // --- Utility functions ---
    function escapeHtml(str) {
      if (!str) return "";
      return str.replace(/[&<>"]/g, function(c) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c];
      });
    }
    function filterXSS(str) {
      return str.replace(/<(\s*script|iframe|object|embed|style|link|form|input|button|svg|img)[^>]*?>.*?<\/\1\s*>/gi, '')
                .replace(/<(script|iframe|object|embed|style|link|form|input|button|svg|img)[^>]*?\/?>/gi, '');
    }
    // --- Rich text formatting ---
    function formatContent(str) {
      if (!str) return '';
      str = escapeHtml(str);
      str = str.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
      str = str.replace(/\[color=([#\w]+)\]([\s\S]+?)\[\/color\]/g, '<span style="color:$1;">$2</span>');
      return str.replace(/\n/g, '<br>');
    }
    function insertAtCursor(field, text) {
      if (document.selection) {
        field.focus();
        var sel = document.selection.createRange();
        sel.text = text;
      } else if (field.selectionStart || field.selectionStart === 0) {
        let start = field.selectionStart;
        let end = field.selectionEnd;
        field.value = field.value.substring(0, start) + text + field.value.substring(end);
        field.selectionStart = field.selectionEnd = start + text.length;
      } else { field.value += text; }
      field.focus();
    }
    function todayStr() {
      let d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    // --- Level system ---
    function calcLevel(score, role) {
      if (role === "admin") return 5;
      if (score >= 1000) return 5;
      if (score >= 666) return 4;
      if (score >= 300) return 3;
      if (score >= 100) return 2;
      return 1;
    }
    function levelBadge(level) {
      let txts = ['Lv.1', 'Lv.2', 'Lv.3', 'Lv.4', 'Lv.5'];
      let cls = ['level-1', 'level-2', 'level-3', 'level-4', 'level-5'];
      return `<span class="level-badge ${cls[level-1]}">${txts[level-1]}</span>`;
    }
    // --- Sensitive words detection ---
    var sensitiveWords = ["è„è¯", "æ”¿æ²»", "æ•æ„Ÿ", "badword"];
    function checkSensitive(text) {
      let found = sensitiveWords.filter(word => text.indexOf(word) !== -1);
      return found.length ? found : null;
    }
    // --- Data persistence using localStorage with simple obfuscation ---
    function encodeData(data) {
      return btoa(JSON.stringify(data));
    }
    function decodeData(str, defaultVal) {
      try { return JSON.parse(atob(str)); }
      catch(e) { return defaultVal; }
    }
    // --- Global Data Persistence ---
    let defaultUsers = {
      "master": {
        password: "123456",
        nickname: "è®ºå›ç®¡ç†å‘˜",
        role: "admin",
        email: "admin@forum.com",
        avatar: "",
        regDate: todayStr(),
        lastSign: "",
        score: 1000,
        fav: [],
        banInfo: { accessBanUntil: 0, chatBanUntil: 0 }
      }
    };
    let users = decodeData(localStorage.getItem('obf_users'), defaultUsers);
    let posts = decodeData(localStorage.getItem('obf_posts'), []);
    let currentUser = JSON.parse(localStorage.getItem('obf_current_user') || 'null');
    let forumSettings = decodeData(localStorage.getItem('obf_settings'), 
      {"pageSize":5, "darkMode":false, "categories":["ç»¼åˆ", "æŠ€æœ¯", "çŒæ°´"]});
    let announcement = localStorage.getItem('obf_announcement') || 'æ¬¢è¿æ¥åˆ°é«˜çº§ç®€æ˜“è®ºå›ï¼ç®¡ç†å‘˜(master)å¯åœ¨â€œè®ºå›è®¾ç½®â€ä¸­å‘å¸ƒå…¬å‘Šã€‚';
    let drafts = decodeData(localStorage.getItem('obf_drafts'), {});
    let reports = decodeData(localStorage.getItem('obf_reports'), []);
    let traffic = decodeData(localStorage.getItem('obf_traffic'), {});
    // Ensure posts and users structure
    posts.forEach(p => {
      if (typeof p.views !== 'number') p.views = 0;
      if (!Array.isArray(p.likes)) p.likes = [];
      if (!Array.isArray(p.favs)) p.favs = [];
      if (!Array.isArray(p.replies)) p.replies = [];
      if (typeof p.sticky !== 'boolean') p.sticky = false;
      if (typeof p.category !== 'string') p.category = forumSettings.categories[0];
      if (!Array.isArray(p.attachments)) p.attachments = [];
      if (typeof p.draft !== 'boolean') p.draft = false;
      if (!Array.isArray(p.reports)) p.reports = [];
    });
    Object.keys(users).forEach(u => {
      let user = users[u];
      if (!user.email) user.email = '';
      if (!user.avatar) user.avatar = '';
      if (!user.regDate) user.regDate = todayStr();
      if (!user.lastSign) user.lastSign = '';
      if (!user.score) user.score = (u === 'master' ? 1000 : 0);
      if (!Array.isArray(user.fav)) user.fav = [];
      if (!user.banInfo) user.banInfo = { accessBanUntil: 0, chatBanUntil: 0 };
    });
    function save() {
      localStorage.setItem('obf_users', encodeData(users));
      localStorage.setItem('obf_posts', encodeData(posts));
      localStorage.setItem('obf_current_user', JSON.stringify(currentUser));
      localStorage.setItem('obf_settings', encodeData(forumSettings));
      localStorage.setItem('obf_announcement', announcement);
      localStorage.setItem('obf_drafts', encodeData(drafts));
      localStorage.setItem('obf_reports', encodeData(reports));
      localStorage.setItem('obf_traffic', encodeData(traffic));
    }
    // --- Dark Mode ---
    function updateDarkMode() {
      document.getElementById('body').className = forumSettings.darkMode ? 'dark-mode' : '';
    }
    updateDarkMode();
    // --- Traffic Update ---
    function updateTraffic() {
      let today = todayStr();
      if (!traffic[today]) { traffic[today] = { count: 0, ips: [] }; }
      traffic[today].count++;
      let fakeIP = "192.168." + Math.floor(Math.random() * 256) + "." + Math.floor(Math.random() * 256);
      if (traffic[today].ips.indexOf(fakeIP) === -1) { traffic[today].ips.push(fakeIP); }
      save();
    }
    updateTraffic();
    // --- Navigation ---
    function renderNav() {
      let nav = document.getElementById('nav');
      if (currentUser) {
        let user = users[currentUser];
        let role = user.role || "user";
        let level = calcLevel(user.score, user.role);
        nav.innerHTML = `
          æ¬¢è¿, <b>${user.nickname}</b> ${levelBadge(level)}
          <span style="font-size:0.95em;color:#888;">(${role === "admin" ? "ç®¡ç†å‘˜" : "æ™®é€šç”¨æˆ·"})</span> |
          <button onclick="showMain()">è®ºå›é¦–é¡µ</button>
          <button onclick="showPostForm()">å‘å¸–</button>
          <button onclick="showUserProfile()">ä¸ªäººèµ„æ–™</button>
          <button onclick="showDrafts()">è‰ç¨¿ç®±</button>
          <button onclick="showFav()">æˆ‘çš„æ”¶è—</button>
          <button onclick="signIn()">æ¯æ—¥ç­¾åˆ°</button>
          ${role === "admin" ? '<button onclick="showUserList()">ç”¨æˆ·ç®¡ç†</button><button onclick="showSettings()">è®ºå›è®¾ç½®</button><button onclick="showReportList()">ä¸¾æŠ¥ç®¡ç†</button><button onclick="showTraffic()">æµé‡ç»Ÿè®¡</button><button onclick="showBanPanel()">å°ç¦ç®¡ç†</button>' : ''}
          <button onclick="logout()">é€€å‡ºç™»å½•</button>
          <button onclick="toggleDarkMode()">${forumSettings.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
        `;
      } else {
        nav.innerHTML = `
          <button onclick="showLogin()">ç™»å½•</button>
          <button onclick="showRegister()">æ³¨å†Œ</button>
          <button onclick="toggleDarkMode()">${forumSettings.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
        `;
      }
    }
    // --- Main Forum ---
    function showMain(page = 1, searchTerm = '', category = 'å…¨éƒ¨') {
      renderNav();
      let main = document.getElementById('main');
      let annHtml = `<div class="announcement"><b>å…¬å‘Šï¼š</b> ${escapeHtml(announcement)}</div>`;
      let searchHtml = `
        <div class="search-form">
          <form onsubmit="searchPosts(event)">
            <input name="keyword" placeholder="æœç´¢æ ‡é¢˜ã€å†…å®¹ã€ä½œè€…" value="${searchTerm.replace(/"/g, '&quot;')}">
            <select name="category">
              <option value="å…¨éƒ¨"${category==='å…¨éƒ¨'?' selected':''}>å…¨éƒ¨åˆ†ç±»</option>
              ${forumSettings.categories.map(cat => `<option value="${cat}"${category===cat?' selected':''}>${cat}</option>`).join('')}
            </select>
            <button type="submit">æœç´¢</button>
          </form>
        </div>
      `;
      let filtered = posts.filter(p => {
        if (p.draft) return false;
        if (category !== 'å…¨éƒ¨' && p.category !== category) return false;
        if (!searchTerm) return true;
        let kw = searchTerm.toLowerCase();
        return (p.title.toLowerCase().includes(kw) ||
                p.content.toLowerCase().includes(kw) ||
                ((users[p.author]?.nickname || p.author).toLowerCase().includes(kw)));
      });
      filtered.sort((a, b) => (b.sticky ? 1 : 0) - (a.sticky ? 1 : 0) || new Date(b.time) - new Date(a.time));
      let pageSize = forumSettings.pageSize;
      let totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      let curPage = Math.min(Math.max(page, 1), totalPages);
      let html = annHtml + searchHtml + `<h2>å¸–å­åˆ—è¡¨</h2>`;
      html += `<div style="margin-bottom:10px;">`;
      forumSettings.categories.forEach(cat => {
        let cnt = posts.filter(p => !p.draft && p.category === cat).length;
        html += `<span class="category-label">${cat}: ${cnt}</span> `;
      });
      html += `</div>`;
      if (filtered.length === 0) { html += `<p>æš‚æ— å¸–å­ã€‚</p>`; }
      else {
        html += filtered.slice((curPage - 1) * pageSize, curPage * pageSize).map(p => `
          <div class="post${p.sticky ? ' sticky' : ''}">
            <div class="title">
              ${p.sticky ? '<span style="color:#b77;font-size:0.95em;">[ç½®é¡¶]</span>' : ''}
              <span class="category-label">${escapeHtml(p.category)}</span>
              <a href="#" onclick="showPost(${posts.indexOf(p)}); return false;">${escapeHtml(p.title)}</a>
              ${p.attachments.some(a => a.type === 'video') ? `<span title="æœ‰è§†é¢‘">ğŸ¬</span>` : ''}
              ${p.attachments.some(a => a.type === 'file') ? `<span title="æœ‰é™„ä»¶">ğŸ“</span>` : ''}
            </div>
            <div class="meta">
              ä½œè€…: ${users[p.author]?.nickname || p.author} ${levelBadge(calcLevel(users[p.author]?.score || 0, users[p.author]?.role))}
              | æ—¶é—´: ${p.time} | å›å¤: ${p.replies.length} | æµè§ˆ: ${p.views}
              | <span title="ç‚¹èµæ•°">ğŸ‘${p.likes.length}</span> | <span title="æ”¶è—æ•°">â­${p.favs.length}</span>
            </div>
          </div>
        `).join('');
        html += `<div class="pagination">`;
        if (curPage > 1) html += `<button onclick="showMain(${curPage-1},'${searchTerm}','${category}')">&lt;ä¸Šä¸€é¡µ</button>`;
        for (let i = 1; i <= totalPages; i++)
          html += `<button onclick="showMain(${i},'${searchTerm}','${category}')"${i===curPage?' style="font-weight:bold"':''}>${i}</button>`;
        if (curPage < totalPages) html += `<button onclick="showMain(${curPage+1},'${searchTerm}','${category}')">ä¸‹ä¸€é¡µ&gt;</button>`;
        html += `</div>`;
      }
      main.innerHTML = html;
    }
    function searchPosts(e) {
      e.preventDefault();
      let kw = e.target.keyword.value.trim();
      let cat = e.target.category.value;
      showMain(1, kw, cat);
    }
    // --- Like and Favorite ---
    function toggleLike(idx) {
      if (!currentUser) return showLogin();
      let p = posts[idx];
      let likeIdx = p.likes.indexOf(currentUser);
      if (likeIdx >= 0) { p.likes.splice(likeIdx, 1); }
      else { p.likes.push(currentUser); }
      save();
      showPost(idx);
    }
    function toggleFav(idx) {
      if (!currentUser) return showLogin();
      let p = posts[idx];
      let favIdx = p.favs.indexOf(currentUser);
      let userFav = users[currentUser].fav;
      let fid = p.id || idx;
      let userFavIdx = userFav.indexOf(fid);
      if (favIdx >= 0) {
        p.favs.splice(favIdx, 1);
        if (userFavIdx >= 0) userFav.splice(userFavIdx, 1);
      } else {
        p.favs.push(currentUser);
        if (userFavIdx < 0) userFav.push(fid);
      }
      save();
      showPost(idx);
    }
    function showFav() {
      if (!currentUser) return showLogin();
      renderNav();
      let userFavIds = users[currentUser].fav;
      let favPosts = userFavIds.map(fid => posts[parseInt(fid)]).filter(Boolean);
      let html = `<h2>æˆ‘çš„æ”¶è—</h2>`;
      if (!favPosts.length) html += `<p>æš‚æ— æ”¶è—ã€‚</p>`;
      else {
        html += favPosts.map(p => `
          <div class="post">
            <div class="title">
              <span class="category-label">${escapeHtml(p.category)}</span>
              <a href="#" onclick="showPost(${posts.indexOf(p)}); return false;">${escapeHtml(p.title)}</a>
            </div>
            <div class="meta">
              ä½œè€…: ${users[p.author]?.nickname || p.author} | æ—¶é—´: ${p.time} | å›å¤: ${p.replies.length}
            </div>
          </div>
        `).join('');
      }
      html += `<div><button onclick="showMain()">è¿”å›é¦–é¡µ</button></div>`;
      document.getElementById('main').innerHTML = html;
    }
    // --- Post Details and Reports ---
    function showPost(idx) {
      renderNav();
      let p = posts[idx];
      if (!p) { showMain(); return; }
      p.views++;
      save();
      let isLiked = p.likes.indexOf(currentUser) !== -1;
      let isFaved = p.favs.indexOf(currentUser) !== -1;
      let html = `
        <div class="post${p.sticky ? ' sticky' : ''}">
          <div class="title">
            ${p.sticky ? '<span style="color:#b77;font-size:0.95em;">[ç½®é¡¶]</span>' : ''}
            <span class="category-label">${escapeHtml(p.category)}</span> ${escapeHtml(p.title)}
          </div>
          <div class="meta">
            ä½œè€…: ${users[p.author]?.nickname || p.author} ${levelBadge(calcLevel(users[p.author]?.score || 0, users[p.author]?.role))}
            | æ—¶é—´: ${p.time} | æµè§ˆ: ${p.views} | ç‚¹èµ: <button class="like-btn${isLiked?' liked':''}" onclick="toggleLike(${idx})">${isLiked?'å·²èµ':'ç‚¹èµ'}ï¼ˆ${p.likes.length}ï¼‰</button>
            æ”¶è—: <button class="fav-btn${isFaved?' faved':''}" onclick="toggleFav(${idx})">${isFaved?'å·²æ”¶è—':'æ”¶è—'}ï¼ˆ${p.favs.length}ï¼‰</button>
            ${ canDeletePost(idx) ? `<button class="admin-btn" onclick="editPost(${idx})">ç¼–è¾‘</button>
            <button class="admin-btn" onclick="deletePost(${idx})">åˆ é™¤</button>
            <button class="admin-btn" onclick="toggleSticky(${idx})">${p.sticky?'å–æ¶ˆç½®é¡¶':'ç½®é¡¶'}</button>` : '' }
            <button class="report-btn" onclick="showReportForm(${idx})">ä¸¾æŠ¥</button>
          </div>
          <div>${formatContent(filterXSS(p.content))}</div>
          ${p.attachments.length ? renderAttachments(p.attachments) : ''}
        </div>
        <h3>å›å¤ (${p.replies.length})</h3>
        <div class="reply-list">
          ${p.replies.map((r, ridx) => `
            <div class="reply">
              <div>
                <b>${users[r.author]?.nickname || r.author}</b> ${levelBadge(calcLevel(users[r.author]?.score||0, users[r.author]?.role))}
                (${r.time})
                ${canEditReply(idx, ridx) ? `<button class="admin-btn" onclick="editReply(${idx},${ridx})">ç¼–è¾‘</button>
                <button class="admin-btn" onclick="deleteReply(${idx},${ridx})">åˆ é™¤</button>` : ''}
                <button class="report-btn" onclick="showReportForm(${idx},${ridx})">ä¸¾æŠ¥</button>
              </div>
              <div>${formatContent(filterXSS(r.content))}</div>
            </div>
          `).join('')}
        </div>
      `;
      if (currentUser) {
        html += `
          <div class="reply-form">
            <h4>å‘è¡¨å›å¤</h4>
            <form onsubmit="reply(event,${idx})">
              <textarea name="content" rows="3" required></textarea>
              <div>
                <span>æ’å…¥ï¼š</span>
                <button type="button" onclick="insertAtCursor(this.form.content, '*æ–œä½“*')">æ–œä½“</button>
                <span class="color-btn-group">
                  <button type="button" onclick="insertAtCursor(this.form.content, '[color=red]å½©è‰²å­—[/color]')">çº¢å­—</button>
                  <button type="button" onclick="insertAtCursor(this.form.content, '[color=blue]å½©è‰²å­—[/color]')">è“å­—</button>
                  <button type="button" onclick="insertAtCursor(this.form.content, '[color=green]å½©è‰²å­—[/color]')">ç»¿å­—</button>
                </span>
              </div>
              <button type="submit">å›å¤</button>
            </form>
            <div id="replyMsg"></div>
          </div>
        `;
      } else {
        html += `<div><a href="#" onclick="showLogin();return false">è¯·å…ˆç™»å½•åå›å¤</a></div>`;
      }
      html += `<div style="margin-top:15px;"><button onclick="showMain()">è¿”å›</button></div>`;
      document.getElementById('main').innerHTML = html;
    }
    function renderAttachments(arr) {
      if (!arr.length) return '';
      let html = `<div style="margin-top:8px;"><b>é™„ä»¶ï¼š</b><ul>`;
      arr.forEach(a => {
        if (a.type === 'video') {
          html += `<li><video controls class="video-attach" src="${a.data}" preload="metadata"></video>
                   <span>${escapeHtml(a.name)}</span></li>`;
        } else {
          html += `<li><a href="${a.data}" download="${escapeHtml(a.name)}">${escapeHtml(a.name)}</a></li>`;
        }
      });
      html += `</ul></div>`;
      return html;
    }
    // --- Deletion with permission check ---
    function canDeletePost(idx) {
      let p = posts[idx];
      return currentUser && (currentUser === p.author || (users[currentUser] && users[currentUser].role === "admin"));
    }
    function deletePost(idx) {
      if (!canDeletePost(idx)) { alert("æ— æƒåˆ é™¤æ­¤å¸–å­ï¼"); return; }
      if (!confirm("ç¡®è®¤åˆ é™¤è¯¥å¸–å­ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼")) return;
      posts.splice(idx, 1);
      save();
      alert("å¸–å­å·²åˆ é™¤");
      showMain();
    }
    // --- Report ---
    function showReportForm(idx, ridx) {
      renderNav();
      let html = `<div class="report-form">
          <h3>ä¸¾æŠ¥${ typeof ridx === 'number' ? 'å›å¤' : 'å¸–å­' }</h3>
          <form onsubmit="submitReport(event,${idx},${typeof ridx === 'number' ? ridx : 'null'})">
            <label>ç†ç”±<select name="reason">
              <option>å¹¿å‘Š</option><option>è¾±éª‚</option><option>è¿æ³•å†…å®¹</option><option>è‰²æƒ…</option><option>å…¶ä»–</option>
            </select></label>
            <label>è¡¥å……è¯´æ˜ï¼ˆé€‰å¡«ï¼‰<input name="extra"></label>
            <button type="submit">æäº¤ä¸¾æŠ¥</button>
          </form>
          <div><button onclick="showPost(${idx})">è¿”å›</button></div>
        </div>`;
      document.getElementById('main').innerHTML = html;
    }
    function submitReport(e, idx, ridx) {
      e.preventDefault();
      if (!currentUser) return showLogin();
      let reason = e.target.reason.value;
      let extra = e.target.extra.value.trim();
      reports.push({
        id: reports.length + 1,
        postIdx: idx,
        replyIdx: typeof ridx === 'number' ? ridx : null,
        reporter: currentUser,
        time: new Date().toLocaleString(),
        reason, extra, handled: false
      });
      if (typeof ridx === 'number')
        posts[idx].replies[ridx].reports = (posts[idx].replies[ridx].reports || []).concat([{ reporter: currentUser, reason, extra, time: new Date().toLocaleString() }]);
      else
        posts[idx].reports = (posts[idx].reports || []).concat([{ reporter: currentUser, reason, extra, time: new Date().toLocaleString() }]);
      save();
      alert("ä¸¾æŠ¥æˆåŠŸï¼");
      showPost(idx);
    }
    function showReportList() {
      if (!currentUser || users[currentUser].role !== "admin") return showMain();
      renderNav();
      let html = `<h2>ä¸¾æŠ¥ç®¡ç†</h2>`;
      if (!reports.length) html += `<p>æš‚æ— ä¸¾æŠ¥è®°å½•ã€‚</p>`;
      else {
        html += `<div class="report-list">` + reports.map((r, i) => {
          let type = (r.replyIdx !== null) ? 'å›å¤' : 'å¸–å­';
          let content = type === 'å¸–å­' ? escapeHtml(posts[r.postIdx]?.title || '') : escapeHtml(posts[r.postIdx]?.replies?.[r.replyIdx]?.content || '');
          return `<div style="margin-bottom:10px;">
              <b>[${type}]</b> ${type==='å¸–å­' ? 'æ ‡é¢˜: ' : 'å†…å®¹: '}${content}<br>
              ä¸¾æŠ¥äºº: ${users[r.reporter]?.nickname || r.reporter} | æ—¶é—´: ${r.time}<br>
              ç†ç”±: ${r.reason} ${r.extra ? ('ï¼Œè¯´æ˜ï¼š' + escapeHtml(r.extra)) : ""}<br>
              çŠ¶æ€: <b>${r.handled ? 'å·²å¤„ç†' : 'å¾…å¤„ç†'}</b><br>
              <button class="admin-btn" onclick="handleReport(${i}, true)">é€šè¿‡å¹¶åˆ é™¤</button>
              <button class="admin-btn" onclick="handleReport(${i}, false)">æ ‡è®°ä¸ºå·²å¤„ç†</button>
            </div>`;
        }).join('') + `</div>`;
      }
      html += `<div><button onclick="showMain()">è¿”å›é¦–é¡µ</button></div>`;
      document.getElementById('main').innerHTML = html;
    }
    function handleReport(i, del) {
      let r = reports[i];
      if (!r) return;
      if (del) {
        if (r.replyIdx !== null) { posts[r.postIdx].replies.splice(r.replyIdx, 1); }
        else { posts.splice(r.postIdx, 1); }
      }
      r.handled = true;
      save();
      alert('å·²å¤„ç†');
      showReportList();
    }
    // --- Drafts ---
    function showDrafts() {
      if (!currentUser) return showLogin();
      renderNav();
      let userDrafts = drafts[currentUser] || [];
      let html = `<h2>è‰ç¨¿ç®±</h2>`;
      if (!userDrafts.length) { html += `<p>æš‚æ— è‰ç¨¿ã€‚</p>`; }
      else {
        html += `<ul class="draft-list">` + userDrafts.map((d, i) => `
          <li>
            <b>${escapeHtml(d.title) || '[æ— æ ‡é¢˜]'}</b>
            <button class="draft-btn" onclick="editDraft(${i})">ç¼–è¾‘</button>
            <button class="draft-btn" onclick="deleteDraft(${i})">åˆ é™¤</button>
            <button class="draft-btn" onclick="publishDraft(${i})">å‘å¸ƒ</button>
          </li>
        `).join('') + `</ul>`;
      }
      html += `<div><button onclick="showMain()">è¿”å›</button></div>`;
      document.getElementById('main').innerHTML = html;
    }
    function saveDraft(draft, editingIndex) {
      if (!currentUser) return;
      if (!drafts[currentUser]) drafts[currentUser] = [];
      if (typeof editingIndex === 'number') { drafts[currentUser][editingIndex] = draft; }
      else { drafts[currentUser].push(draft); }
      save();
    }
    function editDraft(i) {
      let d = (drafts[currentUser] || [])[i];
      showPostForm(d, i);
    }
    function deleteDraft(i) {
      if (!confirm("ç¡®è®¤åˆ é™¤è¯¥è‰ç¨¿ï¼Ÿ")) return;
      drafts[currentUser].splice(i, 1);
      save();
      showDrafts();
    }
    function publishDraft(i) {
      let d = drafts[currentUser][i];
      posts.unshift({
        title: d.title,
        content: d.content,
        author: currentUser,
        time: new Date().toLocaleString(),
        replies: [],
        sticky: false,
        views: 0,
        likes: [],
        favs: [],
        category: d.category || forumSettings.categories[0],
        attachments: d.attachments || [],
        draft: false,
        reports: []
      });
      drafts[currentUser].splice(i, 1);
      users[currentUser].score += 10;
      save();
      alert('è‰ç¨¿å·²å‘å¸ƒå¹¶è·å¾—10ç§¯åˆ†ï¼');
      showMain();
    }
    // --- User Management (Admin) ---
    function showUserList() {
      if (!currentUser || users[currentUser].role !== "admin") return showMain();
      renderNav();
      let html = `<h2>ç”¨æˆ·ç®¡ç†</h2>
        <table class="user-list" border="1" cellspacing="0">
          <tr>
            <th>ç”¨æˆ·å</th>
            <th>æ˜µç§°</th>
            <th>ç­‰çº§</th>
            <th>ç§¯åˆ†</th>
            <th>æ³¨å†Œæ—¶é—´</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>`;
      Object.keys(users).forEach(u => {
        let user = users[u];
        html += `<tr>
          <td>${u}</td>
          <td>${user.nickname}</td>
          <td>${levelBadge(calcLevel(user.score, user.role))}</td>
          <td>${user.score}</td>
          <td>${user.regDate}</td>
          <td>${user.banInfo && user.banInfo.accessBanUntil > Date.now() ? `<span style="color:#e74c3c;">è®¿é—®å°ç¦ä¸­</span>` : (user.banInfo && user.banInfo.chatBanUntil > Date.now() ? `<span style="color:#e74c3c;">ç¦è¨€ä¸­</span>` : 'æ­£å¸¸')}</td>
          <td>
            ${u !== "master" ? `
            <button class="admin-btn" onclick="deleteUser('${u}')">åˆ é™¤</button>
            <button class="admin-btn" onclick="toggleAdmin('${u}')">${user.role==="admin"?"é™ä¸ºæ™®é€š":"è®¾ä¸ºç®¡ç†å‘˜"}</button>
            ${user.banInfo && user.banInfo.accessBanUntil > Date.now() ? `<button class="ban-btn" onclick="unbanUser('${u}', 'access')">è§£å°è®¿é—®</button>` : `<button class="ban-btn" onclick="banUserPrompt('${u}', 'access')">å°ç¦è®¿é—®</button>`}
            ${user.banInfo && user.banInfo.chatBanUntil > Date.now() ? `<button class="ban-btn" onclick="unbanUser('${u}', 'chat')">è§£é™¤ç¦è¨€</button>` : `<button class="ban-btn" onclick="banUserPrompt('${u}', 'chat')">å°ç¦ç¦è¨€</button>`}
            ` : ""}
          </td>
        </tr>`;
      });
      html += `</table>
        <div style="margin-top:15px;"><button onclick="showMain()">è¿”å›</button></div>`;
      document.getElementById('main').innerHTML = html;
    }
    function deleteUser(u) {
      if (!confirm("ç¡®è®¤åˆ é™¤ç”¨æˆ·ï¼š" + u + "ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;
      delete users[u];
      posts = posts.filter(p => p.author !== u);
      posts.forEach(p => {
        p.replies = p.replies.filter(r => r.author !== u);
        p.likes = p.likes.filter(l => l !== u);
        p.favs = p.favs.filter(f => f !== u);
      });
      delete drafts[u];
      save();
      alert("å·²åˆ é™¤ç”¨æˆ·åŠå…¶å¸–å­/å›å¤ã€‚");
      showUserList();
    }
    function toggleAdmin(u) {
      users[u].role = users[u].role === "admin" ? "user" : "admin";
      save();
      showUserList();
    }
    function banUserPrompt(u, type) {
      let duration = prompt("è¯·è¾“å…¥å°ç¦æ—¶é•¿ï¼ˆå•ä½ï¼šå°æ—¶ï¼ŒèŒƒå›´1-3600ï¼‰ï¼š");
      let hours = parseInt(duration);
      if (isNaN(hours) || hours < 1 || hours > 3600) { alert("æ—¶é•¿æ— æ•ˆï¼"); return; }
      let until = Date.now() + hours * 3600 * 1000;
      if (type === "access") { users[u].banInfo.accessBanUntil = until; }
      else if (type === "chat") { users[u].banInfo.chatBanUntil = until; }
      save();
      alert("å°ç¦æ“ä½œæˆåŠŸï¼");
      showUserList();
    }
    function unbanUser(u, type) {
      if (type === "access") { users[u].banInfo.accessBanUntil = 0; }
      else if (type === "chat") { users[u].banInfo.chatBanUntil = 0; }
      save();
      alert("è§£ç¦æˆåŠŸï¼");
      showUserList();
    }
    // --- Reply Editing ---
    function canEditReply(idx, ridx) {
      if (!currentUser) return false;
      let r = posts[idx].replies[ridx];
      return currentUser === r.author || (users[currentUser] && users[currentUser].role === "admin");
    }
    function editReply(idx, ridx) {
      let r = posts[idx].replies[ridx];
      renderNav();
      document.getElementById('main').innerHTML = `
        <div class="reply-form">
          <h2>ç¼–è¾‘å›å¤</h2>
          <form onsubmit="doEditReply(event,${idx},${ridx})">
            <textarea name="content" rows="4" required>${escapeHtml(r.content)}</textarea>
            <div>
              <span>æ’å…¥ï¼š</span>
              <button type="button" onclick="insertAtCursor(this.form.content, '*æ–œä½“*')">æ–œä½“</button>
              <span class="color-btn-group">
                <button type="button" onclick="insertAtCursor(this.form.content, '[color=red]å½©è‰²å­—[/color]')">çº¢å­—</button>
                <button type="button" onclick="insertAtCursor(this.form.content, '[color=blue]å½©è‰²å­—[/color]')">è“å­—</button>
                <button type="button" onclick="insertAtCursor(this.form.content, '[color=green]å½©è‰²å­—[/color]')">ç»¿å­—</button>
              </span>
            </div>
            <button type="submit">ä¿å­˜</button>
          </form>
          <div><button onclick="showPost(${idx})">å–æ¶ˆ</button></div>
        </div>
      `;
    }
    function doEditReply(e, idx, ridx) {
      e.preventDefault();
      if (users[currentUser]?.banInfo?.chatBanUntil > Date.now()) { alert('ç¦è¨€ç”¨æˆ·æ— æ³•ç¼–è¾‘'); return; }
      posts[idx].replies[ridx].content = e.target.content.value.trim();
      let sensitive = checkSensitive(posts[idx].replies[ridx].content);
      if (sensitive) { alert("å›å¤ä¸­åŒ…å«æ•æ„Ÿè¯ï¼š" + sensitive.join(", ")); return; }
      save();
      showPost(idx);
    }
    function deleteReply(idx, ridx) {
      if (!confirm("ç¡®è®¤åˆ é™¤è¯¥å›å¤ï¼Ÿ")) return;
      posts[idx].replies.splice(ridx, 1);
      save();
      showPost(idx);
    }
    // --- Post Editing ---
    function editPost(idx) {
      let p = posts[idx];
      showPostForm(p, undefined, idx);
    }
    function doEditPost(e, idx) {
      e.preventDefault();
      let p = posts[idx];
      if (users[p.author]?.banInfo?.chatBanUntil > Date.now()) { alert('ç¦è¨€ç”¨æˆ·æ— æ³•ç¼–è¾‘'); return; }
      p.title = e.target.title.value.trim();
      p.content = e.target.content.value.trim();
      p.category = e.target.category.value || forumSettings.categories[0];
      let sensitive = checkSensitive(p.title + " " + p.content);
      if (sensitive) { alert("å†…å®¹ä¸­åŒ…å«æ•æ„Ÿè¯ï¼š" + sensitive.join(", ")); return; }
      let files = Array.from(e.target.attachments.files);
      let video = files.find(f => f.type === 'video/mp4');
      if (video) {
        if (!video.name.toLowerCase().endsWith(".mp4") || video.size > 80 * 1024 * 1024) {
          alert("è§†é¢‘å¿…é¡»ä¸ºmp4æ ¼å¼ä¸”ä¸è¶…è¿‡80MB");
          return;
        }
      }
      if (files.length) {
        let readerPromises = files.map(file => {
          if (file.type.startsWith('video/')) {
            if (!file.name.toLowerCase().endsWith('.mp4') || file.size > 80 * 1024 * 1024) { return Promise.reject("è§†é¢‘å¿…é¡»ä¸ºmp4æ ¼å¼ä¸”ä¸è¶…è¿‡80MB"); }
          }
          return new Promise(res => {
            let reader = new FileReader();
            reader.onload = function(evt) { res({ name: file.name, data: evt.target.result, type: file.type.startsWith('video/') ? 'video' : 'file' }); };
            reader.readAsDataURL(file);
          });
        });
        Promise.all(readerPromises).then(arr => {
          p.attachments = arr;
          save();
          showPost(idx);
        }).catch(msg => alert(msg));
      } else {
        save();
        showPost(idx);
      }
    }
    // --- User Profile ---
    function showUserProfile() {
      if (!currentUser) return showLogin();
      renderNav();
      let user = users[currentUser];
      let html = `
        <h2>ä¸ªäººèµ„æ–™</h2>
        <div class="profile-info">
          <img src="${user.avatar || 'https://api.dicebear.com/7.x/pixel-art/svg?seed=' + encodeURIComponent(currentUser)}" class="profile-avatar">
          <div class="profile-details">
            <b>${user.nickname}</b> ${levelBadge(calcLevel(user.score, user.role))}<br>
            ç”¨æˆ·å: ${currentUser}<br>
            é‚®ç®±: ${escapeHtml(user.email)}<br>
            æ³¨å†Œæ—¶é—´: ${user.regDate}<br>
            å½“å‰ç§¯åˆ†: <span style="color:#2ecc71; font-weight:bold">${user.score}</span><br>
            ç­‰çº§: ${calcLevel(user.score, user.role)}
          </div>
        </div>
        <form class="profile-form" onsubmit="updateProfile(event)">
          <label>æ˜µç§° <input name="nickname" value="${user.nickname.replace(/"/g, '&quot;')}" required></label>
          <label>é‚®ç®± <input name="email" type="email" value="${escapeHtml(user.email)}"></label>
          <label>ä¸Šä¼ å¤´åƒ <input name="avatar" type="file" accept="image/*"></label>
          <label>ä¿®æ”¹å¯†ç  <input name="password" type="password" placeholder="å¦‚éœ€ä¿®æ”¹è¯·å¡«å†™"></label>
          <button type="submit">ä¿å­˜</button>
        </form>
        <div><button onclick="showMain()">è¿”å›</button></div>
      `;
      document.getElementById('main').innerHTML = html;
    }
    function updateProfile(e) {
      e.preventDefault();
      let nickname = e.target.nickname.value.trim();
      let email = e.target.email.value.trim();
      let pwd = e.target.password.value;
      let user = users[currentUser];
      if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]{2,20}$/.test(nickname)) { alert("æ˜µç§°æ ¼å¼ä¸åˆæ³•"); return; }
      if (email && !/^[\w\.\-]+@[\w\-]+\.[a-zA-Z]{2,}$/.test(email)) { alert("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"); return; }
      user.nickname = nickname;
      user.email = email;
      if (pwd) user.password = pwd;
      let file = e.target.avatar.files[0];
      if (file) {
        if (!file.type.startsWith('image/')) { alert('è¯·ä¸Šä¼ å›¾ç‰‡æ ¼å¼'); return; }
        let reader = new FileReader();
        reader.onload = function(evt) {
          user.avatar = evt.target.result;
          save();
          alert("èµ„æ–™å·²æ›´æ–°");
          showUserProfile();
        };
        reader.readAsDataURL(file);
      } else {
        save();
        alert("èµ„æ–™å·²æ›´æ–°");
        showUserProfile();
      }
    }
    // --- Post Form ---
    function showPostForm(p = {}, editingDraftIndex, editingPostIndex) {
      if (!currentUser) { showLogin(); return; }
      if (users[currentUser]?.banInfo?.chatBanUntil > Date.now()) { alert('ä½ å·²è¢«ç¦è¨€'); return; }
      renderNav();
      let isEditing = typeof editingPostIndex === 'number';
      let isEditingDraft = typeof editingDraftIndex === 'number';
      let attsHtml = '';
      if (p.attachments && p.attachments.length) {
        attsHtml = `<div>å·²æœ‰é™„ä»¶ï¼š${p.attachments.map(a =>
          a.type === 'video' ? `<video controls class="video-attach" src="${a.data}"></video>` :
          `<a href="${a.data}" download="${escapeHtml(a.name)}">${escapeHtml(a.name)}</a>`
        ).join('ï¼Œ')}</div>`;
      }
      document.getElementById('main').innerHTML = `
        <div class="post-form">
          <h2>${isEditing ? 'ç¼–è¾‘å¸–å­' : isEditingDraft ? 'ç¼–è¾‘è‰ç¨¿' : 'å‘æ–°å¸–'}</h2>
          <form onsubmit="${isEditing ? 'doEditPost(event,' + editingPostIndex + ')' : isEditingDraft ? 'doEditDraft(event,' + editingDraftIndex + ')' : 'post(event,' + (isEditingDraft ? editingDraftIndex : '') + ')'}" enctype="multipart/form-data">
            <label>æ ‡é¢˜ <input name="title" value="${escapeHtml(p.title) || ''}" required></label>
            <label>åˆ†ç±»
              <select name="category">
                ${forumSettings.categories.map(cat => `<option value="${cat}"${p.category===cat?' selected':''}>${cat}</option>`).join('')}
              </select>
            </label>
            <label>
              å†…å®¹ <textarea name="content" rows="6" required>${escapeHtml(p.content) || ''}</textarea>
              <div>
                <span>æ’å…¥ï¼š</span>
                <button type="button" onclick="insertAtCursor(this.form.content, '*æ–œä½“*')">æ–œä½“</button>
                <span class="color-btn-group">
                  <button type="button" onclick="insertAtCursor(this.form.content, '[color=red]å½©è‰²å­—[/color]')">çº¢å­—</button>
                  <button type="button" onclick="insertAtCursor(this.form.content, '[color=blue]å½©è‰²å­—[/color]')">è“å­—</button>
                  <button type="button" onclick="insertAtCursor(this.form.content, '[color=green]å½©è‰²å­—[/color]')">ç»¿å­—</button>
                </span>
              </div>
            </label>
            <label>ä¸Šä¼ é™„ä»¶/è§†é¢‘ï¼ˆæ”¯æŒmp4è§†é¢‘â‰¤80MB,å¯å¤šé€‰ï¼‰<input type="file" name="attachments" multiple></label>
            ${attsHtml}
            <button type="submit">${isEditing ? 'ä¿å­˜' : 'å‘å¸ƒ'}</button>
            <button type="button" onclick="saveToDraft(this.form, ${isEditingDraft ? editingDraftIndex : 'undefined'})">${isEditingDraft ? 'ä¿å­˜è‰ç¨¿' : 'å­˜ä¸ºè‰ç¨¿'}</button>
          </form>
          <div><button onclick="showMain()">å–æ¶ˆ</button></div>
          <div id="postMsg"></div>
        </div>
      `;
    }
    function saveToDraft(form, draftIndex) {
      let title = form.title.value.trim();
      let content = form.content.value.trim();
      let category = form.category.value;
      let files = Array.from(form.attachments.files);
      if (!title && !content && files.length === 0) {
        alert('è‰ç¨¿å†…å®¹ä¸èƒ½ä¸ºç©º');
        return;
      }
      if (files.length) {
        let readerPromises = files.map(file => {
          if (file.type.startsWith('video/')) {
            if (!file.name.toLowerCase().endsWith('.mp4') || file.size > 80 * 1024 * 1024) { return Promise.reject("è§†é¢‘å¿…é¡»ä¸ºmp4æ ¼å¼ä¸”ä¸è¶…è¿‡80MB"); }
          }
          return new Promise(res => {
            let reader = new FileReader();
            reader.onload = function(evt) { res({ name: file.name, data: evt.target.result, type: file.type.startsWith('video/') ? 'video' : 'file' }); };
            reader.readAsDataURL(file);
          });
        });
        Promise.all(readerPromises).then(arr => {
          let draft = { title, content, category, attachments: arr };
          saveDraft(draft, draftIndex);
          alert('è‰ç¨¿å·²ä¿å­˜');
          showDrafts();
        }).catch(msg => alert(msg));
      } else {
        let draft = { title, content, category, attachments: [] };
        saveDraft(draft, draftIndex);
        alert('è‰ç¨¿å·²ä¿å­˜');
        showDrafts();
      }
    }
    function doEditDraft(e, i) {
      e.preventDefault();
      let title = e.target.title.value.trim();
      let content = e.target.content.value.trim();
      let category = e.target.category.value;
      let files = Array.from(e.target.attachments.files);
      if (files.length) {
        let readerPromises = files.map(file => {
          if (file.type.startsWith('video/')) {
            if (!file.name.toLowerCase().endsWith('.mp4') || file.size > 80 * 1024 * 1024) { return Promise.reject("è§†é¢‘å¿…é¡»ä¸ºmp4æ ¼å¼ä¸”ä¸è¶…è¿‡80MB"); }
          }
          return new Promise(res => {
            let reader = new FileReader();
            reader.onload = function(evt) { res({ name: file.name, data: evt.target.result, type: file.type.startsWith('video/') ? 'video' : 'file' }); };
            reader.readAsDataURL(file);
          });
        });
        Promise.all(readerPromises).then(arr => {
          drafts[currentUser][i] = { title, content, category, attachments: arr };
          save();
          alert('è‰ç¨¿å·²ä¿å­˜');
          showDrafts();
        }).catch(msg => alert(msg));
      } else {
        let oldAtt = (drafts[currentUser][i] || {}).attachments || [];
        drafts[currentUser][i] = { title, content, category, attachments: oldAtt };
        save();
        alert('è‰ç¨¿å·²ä¿å­˜');
        showDrafts();
      }
    }
    function post(e, editingDraftIndex) {
      e.preventDefault();
      if (users[currentUser]?.banInfo?.chatBanUntil > Date.now()) { alert('ä½ å·²è¢«ç¦è¨€'); return; }
      let title = e.target.title.value.trim();
      let content = e.target.content.value.trim();
      let category = e.target.category.value;
      let sensitive = checkSensitive(title + " " + content);
      if (sensitive) { alert("å†…å®¹ä¸­åŒ…å«æ•æ„Ÿè¯ï¼š" + sensitive.join(", ")); return; }
      let files = Array.from(e.target.attachments.files);
      if (files.length) {
        let readerPromises = files.map(file => {
          if (file.type.startsWith('video/')) {
            if (!file.name.toLowerCase().endsWith('.mp4') || file.size > 80 * 1024 * 1024) { return Promise.reject("è§†é¢‘å¿…é¡»ä¸ºmp4æ ¼å¼ä¸”ä¸è¶…è¿‡80MB"); }
          }
          return new Promise(res => {
            let reader = new FileReader();
            reader.onload = function(evt) { res({ name: file.name, data: evt.target.result, type: file.type.startsWith('video/') ? 'video' : 'file' }); };
            reader.readAsDataURL(file);
          });
        });
        Promise.all(readerPromises).then(arr => {
          posts.unshift({
            title, content, author: currentUser, time: new Date().toLocaleString(),
            replies: [], sticky: false, views: 0, likes: [], favs: [],
            category, attachments: arr, draft: false, reports: []
          });
          if (typeof editingDraftIndex === 'number' && drafts[currentUser]) { drafts[currentUser].splice(editingDraftIndex, 1); }
          users[currentUser].score += 10;
          save();
          document.getElementById('postMsg').innerHTML = `<span class="success">å‘å¸–æˆåŠŸï¼Œè·å¾—10ç§¯åˆ†ï¼</span>`;
          setTimeout(showMain, 800);
        }).catch(msg => alert(msg));
      } else {
        posts.unshift({
          title, content, author: currentUser, time: new Date().toLocaleString(),
          replies: [], sticky: false, views: 0, likes: [], favs: [],
          category, attachments: [], draft: false, reports: []
        });
        if (typeof editingDraftIndex === 'number' && drafts[currentUser]) { drafts[currentUser].splice(editingDraftIndex, 1); }
        users[currentUser].score += 10;
        save();
        document.getElementById('postMsg').innerHTML = `<span class="success">å‘å¸–æˆåŠŸï¼Œè·å¾—10ç§¯åˆ†ï¼</span>`;
        setTimeout(showMain, 800);
      }
    }
    // --- Login / Register / Logout ---
    function showLogin() {
      renderNav();
      document.getElementById('main').innerHTML = `
        <div class="login">
          <h2>ç™»å½•</h2>
          <form onsubmit="login(event)">
            <label>ç”¨æˆ·å <input name="user" required></label>
            <label>å¯†ç  <input name="pass" type="password" required></label>
            <button type="submit">ç™»å½•</button>
          </form>
          <div id="loginMsg"></div>
        </div>
      `;
    }
    function showRegister() {
      renderNav();
      document.getElementById('main').innerHTML = `
        <div class="register">
          <h2>æ³¨å†Œ</h2>
          <form onsubmit="register(event)">
            <label>ç”¨æˆ·å <input name="user" pattern="^[a-zA-Z0-9_]{3,}$" required></label>
            <label>å¯†ç  <input name="pass" type="password" required></label>
            <label>æ˜µç§° <input name="nickname" required></label>
            <label>é‚®ç®±ï¼ˆé€‰å¡«ï¼‰ <input name="email" type="email"></label>
            <button type="submit">æ³¨å†Œ</button>
          </form>
          <div id="registerMsg"></div>
        </div>
      `;
    }
    function login(e) {
      e.preventDefault();
      let user = e.target.user.value.trim();
      let pass = e.target.pass.value;
      let msg = document.getElementById('loginMsg');
      if (users[user] && users[user].password === pass) {
        if (users[user].banInfo && users[user].banInfo.accessBanUntil > Date.now()) {
          msg.innerHTML = `<span class="error">è¯¥ç”¨æˆ·å½“å‰å¤„äºè®¿é—®å°ç¦çŠ¶æ€ï¼</span>`;
          return;
        }
        currentUser = user;
        save();
        msg.innerHTML = `<span class="success">ç™»å½•æˆåŠŸï¼</span>`;
        setTimeout(showMain, 600);
      } else { msg.innerHTML = `<span class="error">ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚</span>`; }
    }
    function register(e) {
      e.preventDefault();
      let user = e.target.user.value.trim();
      let pass = e.target.pass.value;
      let nickname = e.target.nickname.value.trim();
      let email = e.target.email.value.trim();
      let msg = document.getElementById('registerMsg');
      if (users[user]) { msg.innerHTML = `<span class="error">ç”¨æˆ·åå·²å­˜åœ¨ã€‚</span>`; return; }
      if (user.length < 3) { msg.innerHTML = `<span class="error">ç”¨æˆ·åéœ€è‡³å°‘3ä½ã€‚</span>`; return; }
      if (email && !/^[\w\.\-]+@[\w\-]+\.[a-zA-Z]{2,}$/.test(email)) { msg.innerHTML = `<span class="error">é‚®ç®±æ ¼å¼ä¸æ­£ç¡®ã€‚</span>`; return; }
      users[user] = {
        password: pass,
        nickname,
        role: "user",
        email,
        avatar: "",
        regDate: todayStr(),
        lastSign: "",
        score: 6,
        fav: [],
        banInfo: { accessBanUntil: 0, chatBanUntil: 0 }
      };
      save();
      msg.innerHTML = `<span class="success">æ³¨å†ŒæˆåŠŸï¼Œè·å¾—6ç§¯åˆ†ï¼è¯·ç™»å½•ã€‚</span>`;
      setTimeout(showLogin, 1000);
    }
    function logout() {
      currentUser = null;
      save();
      showMain();
    }
    // --- Forum Settings (Admin) ---
    function showSettings() {
      if (!currentUser || users[currentUser].role !== "admin") return showMain();
      renderNav();
      document.getElementById('main').innerHTML = `
        <h2>è®ºå›è®¾ç½®</h2>
        <form class="settings-form" onsubmit="updateSettings(event)">
          <label>æ¯é¡µå¸–å­æ•° <input name="pageSize" type="number" min="1" max="20" value="${forumSettings.pageSize}"></label>
          <label>åˆ†ç±»ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ <input name="categories" value="${forumSettings.categories.join(',')}"></label>
          <label>å…¬å‘Š <textarea name="announcement" rows="3">${escapeHtml(announcement)}</textarea></label>
          <label>æš—é»‘æ¨¡å¼ <input type="checkbox" name="darkMode"${forumSettings.darkMode?' checked':''}></label>
          <button type="submit">ä¿å­˜è®¾ç½®</button>
        </form>
        <div style="margin-top:12px;"><button onclick="showMain()">è¿”å›</button></div>
      `;
    }
    function updateSettings(e) {
      e.preventDefault();
      let ps = parseInt(e.target.pageSize.value) || 5;
      let cats = e.target.categories.value.split(',').map(s => s.trim()).filter(Boolean);
      let ann = e.target.announcement.value;
      let dark = e.target.darkMode.checked;
      forumSettings.pageSize = ps;
      forumSettings.categories = cats.length ? cats : ["ç»¼åˆ"];
      announcement = ann;
      forumSettings.darkMode = dark;
      save();
      updateDarkMode();
      alert('è®¾ç½®å·²ä¿å­˜');
      showSettings();
    }
    function toggleDarkMode() {
      forumSettings.darkMode = !forumSettings.darkMode;
      save();
      updateDarkMode();
      renderNav();
    }
    // --- Daily Sign-in ---
    function signIn() {
      if (!currentUser) return showLogin();
      let user = users[currentUser];
      let today = todayStr();
      if (user.lastSign === today) { alert('ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ˜å¤©å†æ¥ï¼'); return; }
      user.lastSign = today;
      user.score += 10;
      save();
      alert('ç­¾åˆ°æˆåŠŸï¼Œè·å¾—10ç§¯åˆ†ï¼');
      showUserProfile();
    }
    // --- Traffic and Ban Panel (Admin) ---
    function showTraffic() {
      if (!currentUser || users[currentUser].role !== "admin") return showMain();
      renderNav();
      let today = todayStr();
      let todayTraffic = traffic[today] || { count: 0, ips: [] };
      let html = `<h2>ä»Šæ—¥æµé‡ç»Ÿè®¡ (${today})</h2>
        <p>è®¿é—®æ¬¡æ•°: ${todayTraffic.count}</p>
        <p>è®¿é—®è€…IPåœ°å€: ${todayTraffic.ips.join(', ') || 'æ— '}</p>
        <div><button onclick="showMain()">è¿”å›</button></div>`;
      document.getElementById('main').innerHTML = html;
    }
    function showBanPanel() {
      if (!currentUser || users[currentUser].role !== "admin") return showMain();
      renderNav();
      let html = `<h2>å°ç¦ç®¡ç†</h2>
        <p>è¯·é€‰æ‹©è¦æ‰§è¡Œçš„å°ç¦æ“ä½œï¼š</p>
        <button onclick="showUserList()">ç®¡ç†ç”¨æˆ·å°ç¦</button>
        <div><button onclick="showMain()">è¿”å›</button></div>`;
      document.getElementById('main').innerHTML = html;
    }
    // --- Initialization ---
    showMain();
    // --- Global Bindings ---
    window.showMain = showMain;
    window.showLogin = showLogin;
    window.showRegister = showRegister;
    window.showPostForm = showPostForm;
    window.showPost = showPost;
    window.logout = logout;
    window.login = login;
    window.register = register;
    window.post = post;
    window.reply = reply;
    window.searchPosts = searchPosts;
    window.toggleLike = toggleLike;
    window.toggleFav = toggleFav;
    window.showFav = showFav;
    window.showUserList = showUserList;
    window.deleteUser = deleteUser;
    window.toggleAdmin = toggleAdmin;
    window.editPost = editPost;
    window.doEditPost = doEditPost;
    window.deletePost = deletePost;
    window.toggleSticky = toggleSticky;
    window.editReply = editReply;
    window.doEditReply = doEditReply;
    window.deleteReply = deleteReply;
    window.showUserProfile = showUserProfile;
    window.updateProfile = updateProfile;
    window.showSettings = showSettings;
    window.updateSettings = updateSettings;
    window.toggleDarkMode = toggleDarkMode;
    window.showDrafts = showDrafts;
    window.saveToDraft = saveToDraft;
    window.editDraft = editDraft;
    window.deleteDraft = deleteDraft;
    window.publishDraft = publishDraft;
    window.doEditDraft = doEditDraft;
    window.showReportForm = showReportForm;
    window.submitReport = submitReport;
    window.showReportList = showReportList;
    window.handleReport = handleReport;
    window.signIn = signIn;
    window.showTraffic = showTraffic;
    window.showBanPanel = showBanPanel;
    window.banUserPrompt = banUserPrompt;
    window.unbanUser = unbanUser;
    window.canEditReply = canEditReply;
    window.canDeletePost = canDeletePost;
  </script>
</body>
</html>
